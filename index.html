<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reliable Chat v2.1</title>
  <style>
    /* Previous CSS remains unchanged */
    :root { /* ... */ }
    body { /* ... */ }
    .chat-container { /* ... */ }
    .messages { /* ... */ }
    .message { /* ... */ }
    .message.self { /* ... */ }
    .input-area { /* ... */ }
    input[type="text"] { /* ... */ }
    button { /* ... */ }
    .user-id { /* ... */ }
  </style>
</head>
<body>
  <div class="user-id" id="userId">Your ID: <span id="userIdValue">...</span></div>
  <div class="chat-container">
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Persistent user ID
    const userId = localStorage.getItem('chatUserId') || `user-${Math.random().toString(36).substring(2, 15)}`;
    localStorage.setItem('chatUserId', userId);
    document.getElementById('userIdValue').textContent = userId;

    // Connection manager (Nuclear Fix implementation)
    const connection = {
      socket: null,
      messageQueue: [],
      isOnline: false,

      init() {
        this.socket = io('http://localhost:3000', {
          transports: ['websocket'],
          upgrade: false,
          reconnectionAttempts: 5
        });

        this.socket.on('connect', () => {
          this.isOnline = true;
          document.getElementById('userId').style.color = '#2ecc71';
          this.flushQueue();
        });

        this.socket.on('disconnect', () => {
          this.isOnline = false;
          document.getElementById('userId').style.color = '#e74c3c';
        });

        this.socket.on('newMessage', this.handleIncoming);
      },

      send(payload) {
        if(this.isOnline) {
          this.socket.emit('sendMessage', payload, (ack) => {
            if(ack?.status !== 'received') {
              this.messageQueue.push(payload);
            }
          });
        } else {
          this.messageQueue.push(payload);
        }
      },

      flushQueue() {
        while(this.messageQueue.length > 0) {
          this.send(this.messageQueue.shift());
        }
      },

      handleIncoming(msg) {
        const messagesContainer = document.getElementById('messages');
        messagesContainer.appendChild(createMessageElement(msg));
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    };

    // Message element creator
    function createMessageElement(msg) {
      const div = document.createElement('div');
      div.className = `message ${msg.senderId === userId ? 'self' : ''}`;
      div.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">
          ${msg.senderId} ${msg.senderId === userId ? '(You)' : ''}
        </div>
        <div>${msg.content}</div>
        <div style="font-size: 0.8em; margin-top: 5px; opacity: 0.7;">
          ${new Date(msg.timestamp).toLocaleTimeString()}
        </div>
      `;
      return div;
    }

    // Enhanced send function
    function sendMessage() {
      try {
        const input = document.getElementById('messageInput');
        const btn = document.querySelector('button');
        const message = input.value.trim();
        
        if (!message) return;
        
        btn.disabled = true;
        btn.textContent = 'Sending...';
        input.disabled = true;
        
        connection.send({
          senderId: userId,
          content: message,
          timestamp: new Date().toISOString()
        });
        
        input.value = '';
      } catch(error) {
        console.error('Send error:', error);
        alert('Message failed: ' + error.message);
      } finally {
        setTimeout(() => {
          document.querySelector('button').disabled = false;
          document.querySelector('button').textContent = 'Send';
          input.disabled = false;
        }, 1000);
      }
    }

    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
      connection.init();
      
      document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    });
  </script>
</body>
</html>
